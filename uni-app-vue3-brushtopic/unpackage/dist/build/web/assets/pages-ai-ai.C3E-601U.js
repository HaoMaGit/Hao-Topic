var e,a;import{d as t,b as l,w as o,e as n,n as s,j as r,t as i,v as u,y as c,z as d,p as m,i as p,r as h,g as v,A as f,B as y,a as g,C as b,k,l as x,F as S,x as _,D as w,E as C,S as I,f as A,G as $,H as V,s as j,h as U,I as B,J as H,K as z,L as E}from"./index-BGdZDLVO.js";import{_ as N}from"./uni-icons.aWtZdbs2.js";import{_ as T,a as D,r as R}from"./request.RFVXOHA2.js";import{_ as L,a as F}from"./zero-markdown-view.DmmhTn2E.js";import{m as P,a as K,_ as O}from"./uv-icon.DXxGSX6z.js";import{_ as M}from"./uv-loading-icon.BIaIFGeR.js";const J=T({name:"uv-textarea",mixins:[P,K,{props:{value:{type:[String,Number],default:""},modelValue:{type:[String,Number],default:""},placeholder:{type:[String,Number],default:""},placeholderClass:{type:String,default:"textarea-placeholder"},placeholderStyle:{type:[String,Object],default:"color: #c0c4cc"},height:{type:[String,Number],default:70},confirmType:{type:String,default:"return"},disabled:{type:Boolean,default:!1},count:{type:Boolean,default:!1},focus:{type:Boolean,default:!1},autoHeight:{type:Boolean,default:!1},fixed:{type:Boolean,default:!1},cursorSpacing:{type:Number,default:0},cursor:{type:[String,Number],default:""},showConfirmBar:{type:Boolean,default:!0},selectionStart:{type:Number,default:-1},selectionEnd:{type:Number,default:-1},adjustPosition:{type:Boolean,default:!0},disableDefaultPadding:{type:Boolean,default:!1},holdKeyboard:{type:Boolean,default:!1},maxlength:{type:[String,Number],default:140},border:{type:String,default:"surround"},formatter:{type:[Function,null],default:null},ignoreCompositionEvent:{type:Boolean,default:!0},confirmHold:{type:Boolean,default:!1},textStyle:{type:[Object,String],default:()=>{}},countStyle:{type:[Object,String],default:()=>{}},...null==(a=null==(e=uni.$uv)?void 0:e.props)?void 0:a.textarea}}],data:()=>({innerValue:"",focused:!1,innerFormatter:e=>e}),created(){this.innerValue=this.modelValue},watch:{value(e){this.innerValue=e},modelValue(e){this.innerValue=e}},computed:{textareaClass(){let e=[],{border:a,disabled:t}=this;return"surround"===a&&(e=e.concat(["uv-border","uv-textarea--radius"])),"bottom"===a&&(e=e.concat(["uv-border-bottom","uv-textarea--no-radius"])),t&&e.push("uv-textarea--disabled"),e.join(" ")},textareaStyle(){return this.$uv.deepMerge({},this.$uv.addStyle(this.customStyle))},maxlen(){return this.maxlength<0?this.maxlength<0?-1:140:this.maxlength},getCount(){try{return this.innerValue.length>this.maxlen?this.maxlen:this.innerValue.length}catch(e){return 0}}},methods:{setFormatter(e){this.innerFormatter=e},onFocus(e){this.$emit("focus",e)},onBlur(e){this.$emit("blur",e),this.$uv.formValidate(this,"blur")},onLinechange(e){this.$emit("linechange",e)},onInput(e){let{value:a=""}=e.detail||{};const t=(this.formatter||this.innerFormatter)(a);this.innerValue=a,this.$nextTick((()=>{this.innerValue=t,this.valueChange()}))},valueChange(){const e=this.innerValue;this.$nextTick((()=>{this.$emit("input",e),this.$emit("update:modelValue",e),this.$emit("change",e),this.$uv.formValidate(this,"change")}))},onConfirm(e){this.$emit("confirm",e)},onKeyboardheightchange(e){this.$emit("keyboardheightchange",e)}}},[["render",function(e,a,h,v,f,y){const g=d,b=m,k=p;return t(),l(k,{class:c(["uv-textarea",y.textareaClass]),style:s([y.textareaStyle])},{default:o((()=>[n(g,{class:"uv-textarea__field",value:f.innerValue,style:s([{height:e.autoHeight?"auto":e.$uv.addUnit(e.height)},e.$uv.addStyle(e.textStyle)]),placeholder:e.placeholder,"placeholder-style":e.$uv.addStyle(e.placeholderStyle,"string"),"placeholder-class":e.placeholderClass,disabled:e.disabled,focus:e.focus,autoHeight:e.autoHeight,fixed:e.fixed,cursorSpacing:e.cursorSpacing,cursor:e.cursor,showConfirmBar:e.showConfirmBar,selectionStart:e.selectionStart,selectionEnd:e.selectionEnd,adjustPosition:e.adjustPosition,disableDefaultPadding:e.disableDefaultPadding,holdKeyboard:e.holdKeyboard,maxlength:y.maxlen,confirmType:e.confirmType,ignoreCompositionEvent:e.ignoreCompositionEvent,"confirm-hold":e.confirmHold,onFocus:y.onFocus,onBlur:y.onBlur,onLinechange:y.onLinechange,onInput:y.onInput,onConfirm:y.onConfirm,onKeyboardheightchange:y.onKeyboardheightchange},null,8,["value","style","placeholder","placeholder-style","placeholder-class","disabled","focus","autoHeight","fixed","cursorSpacing","cursor","showConfirmBar","selectionStart","selectionEnd","adjustPosition","disableDefaultPadding","holdKeyboard","maxlength","confirmType","ignoreCompositionEvent","confirm-hold","onFocus","onBlur","onLinechange","onInput","onConfirm","onKeyboardheightchange"]),e.count&&-1!=y.maxlen?(t(),l(b,{key:0,class:"uv-textarea__count",style:s([{"background-color":e.disabled?"transparent":"#fff"},e.$uv.addStyle(e.countStyle)])},{default:o((()=>[r(i(y.getCount)+"/"+i(y.maxlen),1)])),_:1},8,["style"])):u("",!0)])),_:1},8,["class","style"])}],["__scopeId","data-v-2ec10f78"]]),q=[];for(let Z=0;Z<256;++Z)q.push((Z+256).toString(16).slice(1));let G;const Y=new Uint8Array(16);const Q={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function W(e,a,t){var l;if(Q.randomUUID&&!a&&!e)return Q.randomUUID();const o=(e=e||{}).random??(null==(l=e.rng)?void 0:l.call(e))??function(){if(!G){if("undefined"==typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");G=crypto.getRandomValues.bind(crypto)}return G(Y)}();if(o.length<16)throw new Error("Random bytes length must be >= 16");if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,a){if((t=t||0)<0||t+16>a.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let e=0;e<16;++e)a[t+e]=o[e];return a}return function(e,a=0){return(q[e[a+0]]+q[e[a+1]]+q[e[a+2]]+q[e[a+3]]+"-"+q[e[a+4]]+q[e[a+5]]+"-"+q[e[a+6]]+q[e[a+7]]+"-"+q[e[a+8]]+q[e[a+9]]+"-"+q[e[a+10]]+q[e[a+11]]+q[e[a+12]]+q[e[a+13]]+q[e[a+14]]+q[e[a+15]]).toLowerCase()}(o)}const X=T({__name:"ai",setup(e){const a=h(v("role")),d=h(JSON.parse(v("h5UserInfo"))),m=h(localStorage.getItem(d.value.account+"token")),T=h(localStorage.getItem("aiMode")||"system"),P=f([{label:"系统模式",value:"system",desc:1===a.value?"AI从系统题库和会员自定义题库中随机提取题目HaoAi会校验你的回答":"AI从系统题库中随机提取题目HaoAi会校验你的回答"},{label:"模型模式",value:"model",desc:"完全使用AI生成的题目HaoAi会校验你的回答"},{label:"混合模式",value:"mix",desc:"AI随机混合系统题库和AI生成题目HaoAi会校验你的回答"}]),K=h(1===a.value?"请输入系统中和会员自定义的正确的题目专题，AI将自动生成题目":"请输入系统中的正确的题目专题，AI将自动生成题目");y((()=>T.value),(()=>{"system"===T.value?K.value="请输入题目专题，AI将自动生成题目":"model"!==T.value&&"mix"!==T.value||(K.value="请输入给AI你想刷的题目类型，AI将自动生成题目")}));const q=h(!1),G=h([]),Y=h(!1),Q=h(0),X=h(W()),Z=f([{prompt:"我是"+d.value.nickname||d.value.account,chatId:X.value,model:T.value,content:"你好，我是HaoAi 1.0，你的面试题AI助手！",memoryId:Q.value}]),ee=h([]),ae=h({pageNum:1,pageSize:999,title:null}),te=h(null),le=()=>{he.value?(te.value.open(),oe()):_({title:"当前正在回复中",icon:"none"})},oe=async()=>{const e=await(a=ae.value,D({url:"/ai/model/history",method:"get",params:a}));var a;ee.value=e.data},ne=h(""),se=async(e,a,t,l)=>{j({title:"加载中..."}),ne.value=l,te.value.close(),q.value=!0,re(),G.value=[],G.value[t]=a;const o=await(e=>D({url:"/ai/model/history/"+e,method:"get"}))(e);Y.value=!0,T.value=o.data[0].mode;const n=o.data.map((e=>({prompt:e.title,chatId:e.chatId,content:e.content})));Z.push(...n),X.value=o.data[0].chatId,localStorage.removeItem("chatId"),Q.value=o.data.length,console.log(o.data.length),console.log(Q.value),q.value=!1,U(),await ce()},re=()=>{Z.splice(0,Z.length),Z.push({prompt:"我是"+d.value.nickname||d.value.account,chatId:X.value,model:T.value,content:"你好，我是HaoAi 1.0，你的面试题AI助手！",memoryId:Q.value})},ie=h(null),ue=h(0),ce=async()=>{await w();B().selectAll(".box").boundingClientRect((e=>{if(e){const a=e.reduce(((e,a)=>e+a.height),0);ue.value=a+500}})).exec()},de=e=>{const a=e.replace(/```[\s\S]*?```/g,"").replace(/\*\*/g,"").replace(/\*/g,"").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").trim();H({data:a,success:()=>{_({title:"复制成功",icon:"success",duration:1500})},fail:()=>{_({title:"复制失败",icon:"error",duration:1500})}})},me=h(!1);let pe;const he=h(!0),ve=()=>{pe&&(pe.abort(),pe=null,me.value=!1,he.value=!0)},fe=h(""),ye=()=>{he.value?0!==Q.value?(_({title:"创建对话成功",icon:"success",duration:1500}),setTimeout((()=>{C({url:"/pages/ai/ai"})}),100)):_({title:"已是最新对话",icon:"none",duration:1500}):_({title:"当前正在回复中",icon:"none"})},ge=h(!1);let be;const ke=["正在召唤HaoAi发声中...","HaoAi正在努力变声，请稍等~","语音合成中，马上就能听到啦！","HaoAi正在认真朗读你的内容...","别着急，精彩马上开始！"],xe=h(ke[Math.floor(Math.random()*ke.length)]),Se=h(!1),_e=e=>{e=Ce(e),be&&(be.pause(),be.currentTime=0,be=null),Se.value=!0,ge.value=!0,fetch("http://localhost:9993/api/ai/model/tts",{method:"post",headers:{"Content-Type":"application/json",Authorization:m.value},body:JSON.stringify({text:e})}).then((e=>{if(!e.ok)throw new Error("语音合成请求失败");return e.blob()})).then((e=>{Se.value=!1;const a=URL.createObjectURL(e),t=new Audio(a);be=t,t.play(),t.onended=()=>{ge.value=!1,be=null,URL.revokeObjectURL(a)}})).catch((()=>{console.warn("后端语音合成失败，切换到浏览器原生语音:"),Se.value=!1,we(e)}))},we=e=>{e=Ce(e);const a=new SpeechSynthesisUtterance(e);a.lang="zh-CN",a.rate=1.4,a.pitch=2.5,a.volume=1,window.speechSynthesis.speak(a),ge.value=!0,a.onend=()=>{ge.value=!1}},Ce=e=>e.replace(/#{1,6}\s/g,"").replace(/\*\*|__|\*|_/g,"").replace(/$|$|$|$|!\[/g,"").replace(/`/g,"").split("```").filter(((e,a)=>a%2==0)).join("").replace(/^\s*>/gm,"").replace(/^\s*[-*+]\s/gm,"").replace(/^\s*\d+\.\s/gm,"").replace(/\n+/g," ").replace(/\s+/g," ").trim(),Ie=()=>{ge.value=!1,window.speechSynthesis.cancel(),be&&(be.pause(),be.currentTime=0,be=null)};return(e,a)=>{const h=R(g("uni-icons"),N),v=p,f=I,y=R(g("uni-drawer"),L),j=R(g("zero-markdown-view"),F),U=b("a-avatar"),B=R(g("uv-icon"),O),H=R(g("uv-loading-icon"),M),D=R(g("uv-textarea"),J);return t(),l(v,{class:"ai-box"},{default:o((()=>[n(v,{class:"ai-history"},{default:o((()=>[n(v,{class:"left-icon",onClick:le},{default:o((()=>[n(h,{type:"bars",size:"24",color:"#1677ff"})])),_:1}),0===Q.value?(t(),l(v,{key:0,class:"title"},{default:o((()=>[r("新对话")])),_:1})):(t(),l(v,{key:1,class:"title"},{default:o((()=>[r(i(ne.value),1)])),_:1})),n(v,{class:"right-icon",onClick:ye},{default:o((()=>[n(h,{type:"plusempty",color:"#1677ff",size:"25"})])),_:1})])),_:1}),n(y,{ref_key:"showLeft",ref:te,"mask-click":!0},{default:o((()=>[n(v,{class:"drawer-content"},{default:o((()=>[n(v,{class:"drawer-title"},{default:o((()=>[r("历史记录")])),_:1}),n(f,{"scroll-y":"",class:"history-list"},{default:o((()=>[(t(!0),k(S,null,x(ee.value,((a,u)=>(t(),l(v,{key:e.index,class:"history-group"},{default:o((()=>[n(v,{class:"history-date"},{default:o((()=>[r(i(a.date),1)])),_:2},1024),(t(!0),k(S,null,x(a.aiHistoryVos,((a,n)=>(t(),l(v,{style:s({"background-color":G.value[u]===n?"#f2f3f4":"","pointer-events":he.value?"auto":"none"}),onClick:e=>se(a.id,n,u,a.title),key:e.item,class:"history-item"},{default:o((()=>[r(i(a.title),1)])),_:2},1032,["style","onClick"])))),128))])),_:2},1024)))),128))])),_:1})])),_:1})])),_:1},512),n(v,{class:"ai-content"},{default:o((()=>[q.value?u("",!0):(t(),l(f,{key:0,ref_key:"contentRef",ref:ie,duration:3e3,"scroll-top":ue.value,"scroll-y":"true",class:"scroll-Y","scroll-with-animation":!0,"scroll-anchoring":!0,onScrolltoupper:e.upper},{default:o((()=>[(t(!0),k(S,null,x(Z,((e,a)=>(t(),k("div",{class:"box",key:a},[A("div",{class:"prompt-box"},[A("div",{class:"user-message"},[A("div",{class:c(["message-content",{prompt:!0,"first-prompt":0===a}])},[n(j,{class:"markdown-content",markdown:e.prompt},null,8,["markdown"])],2),d.value.avatar?(t(),k("img",{key:0,class:"avatar",src:d.value.avatar},null,8,["src"])):(t(),l(U,{key:1,class:"avatar",style:{backgroundColor:"#1677ff",fontSize:"20px"}},{default:o((()=>{var e,a;return[r(i(null==(a=null==(e=d.value.account)?void 0:e.charAt(0))?void 0:a.toUpperCase()),1)]})),_:1}))]),A("div",{class:"message-actions"},[ge.value?u("",!0):$((t(),l(v,{key:0,class:"action-icon",onClick:a=>_e(e.prompt)},{default:o((()=>[n(B,{name:"volume",size:"20",color:"#666"})])),_:2},1032,["onClick"])),[[V,!Se.value]]),Se.value?(t(),l(H,{key:1,text:xe.value,color:"#1677ff"},null,8,["text"])):u("",!0),ge.value?$((t(),l(v,{key:2,class:"action-icon",onClick:Ie},{default:o((()=>[n(B,{name:"volume-off",size:"20",color:"#666"})])),_:1},512)),[[V,!Se.value]]):u("",!0),n(v,{class:"action-icon",onClick:a=>de(e.prompt)},{default:o((()=>[n(B,{name:"file-text",size:"21",color:"#666"})])),_:2},1032,["onClick"])])]),A("div",{class:"content-avatar"},[A("img",{class:"avatar",src:"/assets/128-BIgrzm1m.png",alt:""}),e.content?(t(),k("div",{key:1,class:"message-wrapper"},[n(j,{class:"markdown-content",markdown:e.content},null,8,["markdown"]),0!==Q.value?(t(),k("div",{key:0,class:"message-actions"},[ge.value?u("",!0):$((t(),l(v,{key:0,class:"action-icon",onClick:a=>_e(e.content)},{default:o((()=>[n(h,{type:"sound",size:"20",color:"#666"})])),_:2},1032,["onClick"])),[[V,!Se.value]]),Se.value?(t(),l(H,{key:1,text:xe.value,color:"#1677ff"},null,8,["text"])):u("",!0),ge.value?$((t(),l(v,{key:2,class:"action-icon",onClick:Ie},{default:o((()=>[n(B,{name:"volume-off",size:"20",color:"#666"})])),_:1},512)),[[V,!Se.value]]):u("",!0),n(v,{class:"action-icon",onClick:a=>de(e.content)},{default:o((()=>[n(B,{name:"file-text",size:"21",color:"#666"})])),_:2},1032,["onClick"])])):u("",!0)])):(t(),l(v,{key:0},{default:o((()=>[n(H,{color:"#1677ff"})])),_:1}))])])))),128))])),_:1},8,["scroll-top","onScrolltoupper"]))])),_:1}),n(v,{class:"ai-search"},{default:o((()=>[n(D,{adjustPosition:"",modelValue:fe.value,"onUpdate:modelValue":a[0]||(a[0]=e=>fe.value=e),height:"25",placeholder:K.value},null,8,["modelValue","placeholder"]),n(v,{class:"button-group"},{default:o((()=>[n(v,{class:"mode-buttons"},{default:o((()=>[(t(!0),k(S,null,x(P,(e=>(t(),l(v,{key:e.value,class:c(["mode-btn",{active:T.value===e.value}]),onClick:a=>{return t=e.value,void(Y.value?z({title:"切换对话模式",content:"当前已经开启对话，切换对话模式将会开启新的对话！",success:e=>{e.confirm&&(_({title:"创建成功",icon:"success",duration:1500}),setTimeout((()=>{C({url:"/pages/ai/ai"})}),100),E("aiMode",t))}}):T.value=t);var t}},{default:o((()=>[r(i(e.label),1)])),_:2},1032,["class","onClick"])))),128))])),_:1}),n(v,{class:"send-btn"},{default:o((()=>[he.value?(t(),l(h,{key:1,type:"paperplane-filled",size:"24",color:"#1677ff",class:c(["send-icon",{disabled:!fe.value}]),onClick:a[1]||(a[1]=e=>fe.value&&(async()=>{if(he.value=!1,Y.value=!0,fe.value){0===Q.value&&localStorage.setItem("chatId",X.value),Q.value++,Z.push({prompt:fe.value,memoryId:Q.value,chatId:localStorage.getItem("chatId")||X.value,model:T.value,content:"",nickname:d.value.nickname}),fe.value="",await ce();const a=Z[Z.length-1];try{pe=new AbortController,fetch("http://localhost:9993/api/ai/model/chat",{method:"POST",headers:{"Content-Type":"application/json",Authorization:m.value},signal:pe.signal,body:JSON.stringify({...a})}).then((e=>(e.ok||_({title:"HaoAi回复出现点问题请稍后再试！",icon:"none",duration:2e3}),e.body))).then((async e=>{if(!e)return void _({title:"HaoAi回复出现点问题请稍后再试！",icon:"none",duration:2e3});const t=e.getReader(),l=new TextDecoder("utf-8");for(;;)try{if(t){const{value:e,done:o}=await t.read();if(o){_({title:"回复成功",icon:"success",duration:2e3}),he.value=!0,1===Q.value&&(oe(),G.value[0]=0);break}await w((()=>{a.content+=l.decode(e)})),await ce()}}catch(o){"AbortError"===o.name?(_({title:"已暂停回复",icon:"none",duration:2e3}),he.value=!0):_({title:"回复失败"+o,icon:"none",duration:2e3});break}}))}catch(e){console.log(e),"AbortError"===e.name?_({title:"已暂停回复",icon:"none",duration:2e3}):_({title:"发送失败"+e,icon:"none",duration:2e3})}}})())},null,8,["class"])):(t(),l(B,{key:0,name:"pause-circle",class:"pause-icon",size:"24",color:"#ff4d4f",onClick:ve}))])),_:1})])),_:1})])),_:1})])),_:1})}}},[["__scopeId","data-v-3baad9a4"]]);export{X as default};
