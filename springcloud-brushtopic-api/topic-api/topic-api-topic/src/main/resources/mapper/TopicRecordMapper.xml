<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.hao.topic.topic.mapper.TopicRecordMapper">
    <select id="getRank" resultType="java.lang.Long">
        SELECT `rank`
        FROM (SELECT user_id,
                     nickname,
                     SUM(count)                             AS total_count,
                     RANK() OVER (ORDER BY SUM(count) DESC) AS `rank`
              FROM topic_record
              GROUP BY user_id) AS ranked_users
        WHERE user_id = #{userId};
    </select>
    <select id="getCountRank" resultType="com.hao.topic.model.vo.topic.TopicUserRankVo">
        SELECT ranked_users.rank AS `rank`,
        ranked_users.user_id AS userId,
        ranked_users.total_count AS scope,
        COALESCE(NULLIF(users.nickname, ''), users.account) AS nickname,
        users.avatar,
        roles.role_key AS role,
        ranked_users.topic_time as topicTime
        FROM (SELECT user_id,
        SUM(count) AS total_count,
        topic_time,
        RANK() OVER (ORDER BY SUM(count) DESC) AS `rank`
        FROM topic_record
        <where>
            <if test="topicTime != null and topicTime != ''">
                topic_time = #{topicTime}
            </if>
        </where>
        GROUP BY user_id) AS ranked_users
        JOIN sys_user AS users ON ranked_users.user_id = users.id
        JOIN (SELECT user_id, MIN(role_id) AS role_id
        FROM sys_user_role
        GROUP BY user_id) AS user_roles ON users.id = user_roles.user_id
        JOIN sys_role AS roles ON user_roles.role_id = roles.id order by `rank`
    </select>
    <select id="getUserCountRank" resultType="com.hao.topic.model.vo.topic.TopicUserRankVo">
        SELECT ranked_users.rank AS `rank`,
        ranked_users.user_id AS userId,
        ranked_users.total_count AS scope,
        ranked_users.topic_time as topicTime,
        COALESCE(NULLIF(users.nickname, ''), users.account) AS nickname,
        users.avatar,
        roles.role_key AS role
        FROM (SELECT user_id,
        SUM(count) AS total_count,
        topic_time,
        RANK() OVER (ORDER BY SUM(count) DESC) AS `rank`
        FROM topic_record
        <where>
            <if test="topicTime != null and topicTime != ''">
                topic_time = #{topicTime}
            </if>
        </where>
        GROUP BY user_id) AS ranked_users
        JOIN sys_user AS users ON ranked_users.user_id = users.id
        JOIN (SELECT user_id, MIN(role_id) AS role_id
        FROM sys_user_role
        GROUP BY user_id) AS user_roles ON users.id = user_roles.user_id
        JOIN sys_role AS roles ON user_roles.role_id = roles.id where user_roles.user_id = #{userId}
    </select>

    <!-- 统计今日刷题总数 -->
    <select id="countTopicFrequency" resultType="java.lang.Long">
        select sum(count) as count
        from topic_record
        <where>
            <if test="date != null and date != ''">
                topic_time= #{date}
            </if>
        </where>
    </select>

    <!-- 统计15日的刷题数 -->
    <select id="countTopicDay15" resultType="com.hao.topic.model.vo.topic.TopicDataVo">
        WITH RECURSIVE dates AS (SELECT CURDATE() - INTERVAL 14 DAY AS date_value
                                 UNION ALL
                                 SELECT date_value + INTERVAL 1 DAY
                                 FROM dates
                                 WHERE date_value &lt; CURDATE())
        SELECT d.date_value              AS date,
               COALESCE(COUNT(up.id), 0) AS count
        FROM dates d
                 LEFT JOIN topic_record up ON DATE(up.topic_time) = d.date_value
        GROUP BY d.date_value
        ORDER BY d.date_value;
    </select>

    <!-- 统计15日的刷题人数 -->
    <select id="countUserDay15" resultType="com.hao.topic.model.vo.topic.TopicDataVo">
        WITH RECURSIVE dates AS (SELECT CURDATE() - INTERVAL 14 DAY AS date_value
                                 UNION ALL
                                 SELECT date_value + INTERVAL 1 DAY
                                 FROM dates
                                 WHERE date_value &lt; CURDATE())
        SELECT d.date_value                            AS date,
               COALESCE(COUNT(DISTINCT up.user_id), 0) AS count
        FROM dates d
                 LEFT JOIN topic_record up ON DATE(up.topic_time) = d.date_value
        GROUP BY d.date_value
        ORDER BY d.date_value;
    </select>

    <!-- 统计用户刷题总数 -->
    <select id="countTopicUserRecord" resultType="java.lang.Long">
        select sum(count)
        from topic_record
        where user_id = #{currentId};
    </select>

    <!-- 根据日期查用户排名 -->
    <select id="getDateRank" resultType="java.lang.Long">
        SELECT `rank`
        FROM (SELECT user_id,
                     nickname,
                     SUM(count)                             AS total_count,
                     topic_time,
                     RANK() OVER (ORDER BY SUM(count) DESC) AS `rank`
              FROM topic_record
              where topic_time = #{date}
              GROUP BY user_id) AS ranked_users
        WHERE user_id = #{currentId}
    </select>

    <!-- 统计用户最长连续刷题数量 -->
    <select id="selectMaximumCount" resultType="java.lang.Long">
        WITH user_days AS (SELECT user_id,
                                  topic_time,
                                  ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY topic_time)              AS rn,
                                  DATE(topic_time) -
                                  INTERVAL ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY topic_time) DAY AS grp
                           FROM topic_record),
             user_streaks AS (SELECT user_id,
                                     COUNT(*) AS streak_length
                              FROM user_days
                              GROUP BY user_id, grp)
        SELECT MAX(streak_length) AS max_streak_length
        FROM user_streaks
        where user_id = #{currentId}
        GROUP BY user_id;
    </select>

    <!-- 查询用户最近刷题多少天 -->
    <select id="selectRecentConsecutiveCount" resultType="java.lang.Long">
        WITH user_days AS (SELECT topic_time,
                                  DATE(topic_time) - INTERVAL ROW_NUMBER() OVER (ORDER BY topic_time) DAY AS grp
                           FROM (SELECT DISTINCT topic_time
                                 FROM topic_record
                                 WHERE user_id = #{currentId}
                                 ORDER BY topic_time) AS distinct_days),
             streaks AS (SELECT grp,
                                MIN(topic_time) AS start_date,
                                MAX(topic_time) AS end_date,
                                COUNT(*)        AS streak_length
                         FROM user_days
                         GROUP BY grp)
        SELECT streak_length AS recent_streak_length
        FROM streaks
        ORDER BY end_date DESC
        LIMIT 1;
    </select>

    <!-- 根据年份查询用户每日刷题次数 -->
    <select id="userTopicDateCount" resultType="com.hao.topic.model.vo.topic.TopicDataVo">
        SELECT DATE(topic_time) AS date,
               sum(count)       AS count
        FROM topic_record
        WHERE YEAR(topic_time) = #{date}
          and user_id = #{currentId}
        GROUP BY DATE(topic_time)
        ORDER BY date;
    </select>

    <!-- 查询用户刷的最多的专题 -->
    <select id="selectMaxSubject" resultType="java.lang.Long">
        SELECT t.subject_id
        FROM (SELECT subject_id,
                     COUNT(*)        AS num_topics,
                     MAX(topic_time) AS latest_time
              FROM topic_record
              WHERE user_id = #{id}
              GROUP BY subject_id) t
        ORDER BY t.num_topics DESC, t.latest_time DESC
        LIMIT 1;
    </select>


</mapper>